<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Stash ‚Äì earn & share</title>
    <meta name="theme-color" content="#0A64FF">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="manifest" href="data:application/manifest+json,{
        \"name\":\"Stash Social\",
        \"short_name\":\"Stash\",
        \"theme_color\":\"#0A64FF\",
        \"background_color\":\"#E8F1FF\",
        \"display\":\"standalone\",
        \"icons\":[{
            \"src\":\"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'%3E%3Crect width='192' height='192' rx='40' fill='%230A64FF'/%3E%3Ctext x='96' y='130' text-anchor='middle' font-size='80' fill='white'%3Eüì¶%3C/text%3E%3C/svg%3E\",
            \"sizes\":\"192x192\",
            \"type\":\"image/svg+xml\"
        }]
    }">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* ---------- Blue-sky theme ---------- */
        :root {
            --primary: #0A64FF;
            --secondary: #00C2FF;
            --bg: #E8F1FF;
            --card: #FFFFFF;
            --text: #1A2B3C;
            --text-light: #5F6B7A;
            --border: #D0DDEB;
            --radius: 20px;
            --shadow: 0 8px 24px rgba(10,100,255,0.08);
            --nav-height: 70px;
            --header-height: 60px;
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        body {
            background: var(--bg);
            color: var(--text);
            height: 100vh;
            overflow: hidden;
            position: relative;
            padding-bottom: var(--nav-height);
        }
        /* Launch screen */
        #launchScreen {
            position: fixed;
            inset: 0;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            transition: opacity 0.3s;
        }
        .launch-logo { font-size: 5rem; margin-bottom: 20px; animation: float 3s infinite; }
        .launch-title { color: white; font-size: 2.5rem; font-weight: 700; }
        @keyframes float { 0%,100%{transform:translateY(0);} 50%{transform:translateY(-10px);} }
        /* Install banner */
        #installBanner {
            position: fixed; bottom: calc(var(--nav-height) + 20px); left:20px; right:20px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white; border-radius: var(--radius); padding:16px; z-index:10000;
            display: none; align-items:center; gap:12px; box-shadow:0 8px 32px rgba(10,100,255,0.3);
            animation: slideUp 0.3s;
        }
        #installBanner.show { display: flex; }
        .install-close { width:32px; height:32px; border-radius:50%; background:rgba(255,255,255,0.2); display:flex; align-items:center; justify-content:center; cursor:pointer; }
        /* Offline indicator */
        #offlineIndicator {
            position: fixed; top:10px; left:50%; transform:translateX(-50%);
            background: #FF9500; color:white; padding:8px 16px; border-radius:30px;
            z-index:10000; display:none; align-items:center; gap:8px; font-size:0.85rem;
        }
        .toast {
            position: fixed; top:100px; left:50%; transform:translateX(-50%);
            background: var(--primary); color:white; padding:12px 24px; border-radius:40px;
            z-index:3000; font-weight:500; display:none; align-items:center; gap:8px;
            box-shadow:0 4px 12px rgba(0,0,0,0.15); animation: toastSlide 0.3s;
        }
        .toast.show { display:flex; }
        @keyframes toastSlide { from{opacity:0; transform:translateX(-50%) translateY(-20px);} to{opacity:1; transform:translateX(-50%) translateY(0);} }
        .loading-overlay {
            position: fixed; inset:0; background: rgba(255,255,255,0.6); display:none;
            align-items:center; justify-content:center; z-index:3000;
        }
        .spinner { width:50px; height:50px; border:4px solid var(--border); border-top-color: var(--primary); border-radius:50%; animation: spin 1s linear infinite; }
        @keyframes spin { to{transform:rotate(360deg);} }
        /* Header */
        .stash-header {
            height: var(--header-height); background: var(--card); display: flex;
            align-items: center; padding: 0 20px; border-bottom: 1px solid var(--border);
            position: sticky; top:0; z-index:100;
        }
        .header-title { flex:1; font-size:1.6rem; font-weight:700; color: var(--primary); display:flex; align-items:center; gap:8px; }
        .header-actions { display:flex; gap:20px; align-items:center; }
        .header-icon { font-size:1.4rem; color: var(--text-light); cursor:pointer; }
        .user-avatar { width:40px; height:40px; border-radius:40px; background: linear-gradient(135deg, var(--primary), var(--secondary)); display:flex; align-items:center; justify-content:center; color:white; font-weight:600; cursor:pointer; }
        /* Main content */
        .main-content {
            height: calc(100vh - var(--header-height) - var(--nav-height));
            overflow-y: auto; padding: 16px; scroll-behavior: smooth;
        }
        /* Auth */
        .auth-container { max-width:400px; margin:40px auto; background:var(--card); border-radius:var(--radius); padding:32px; box-shadow:var(--shadow); }
        .auth-tabs { display:flex; gap:16px; margin-bottom:24px; }
        .auth-tab { flex:1; text-align:center; padding:12px; font-weight:600; border-bottom:2px solid transparent; cursor:pointer; }
        .auth-tab.active { border-bottom-color:var(--primary); color:var(--primary); }
        .auth-input { width:100%; padding:16px; border:1px solid var(--border); border-radius:40px; margin-bottom:16px; font-size:1rem; background:var(--bg); }
        .auth-btn { width:100%; padding:16px; background:var(--primary); color:white; border:none; border-radius:40px; font-weight:600; font-size:1.1rem; cursor:pointer; }
        /* Compose */
        .compose-card { background:var(--card); border-radius:var(--radius); padding:20px; margin-bottom:24px; box-shadow:var(--shadow); }
        .compose-header { display:flex; gap:12px; align-items:center; margin-bottom:12px; }
        .compose-avatar { width:48px; height:48px; border-radius:48px; background:linear-gradient(135deg, var(--primary), var(--secondary)); display:flex; align-items:center; justify-content:center; color:white; font-weight:600; }
        .compose-textarea { flex:1; border:1px solid var(--border); border-radius:20px; padding:14px 18px; font-size:1rem; background:var(--bg); outline:none; resize:none; }
        .compose-actions { display:flex; justify-content:flex-end; gap:12px; margin-top:12px; }
        .post-btn { background:var(--primary); color:white; border:none; border-radius:40px; padding:12px 30px; font-weight:600; cursor:pointer; }
        /* Stories row */
        .stories-row { display: flex; gap: 12px; overflow-x: auto; padding: 16px 0; margin-bottom: 20px; }
        .story-circle { display: flex; flex-direction: column; align-items: center; cursor: pointer; }
        .story-avatar { width: 70px; height: 70px; border-radius: 70px; background: linear-gradient(45deg, #f09433, #e6683c, #dc2743, #cc2366, #bc1888); padding: 3px; }
        .story-avatar.unseen { animation: pulse-ring 1.5s infinite; }
        .story-avatar img { width: 100%; height: 100%; border-radius: 70px; border: 3px solid white; object-fit: cover; }
        @keyframes pulse-ring { 0% { box-shadow: 0 0 0 0 rgba(10,100,255,0.7); } 70% { box-shadow: 0 0 0 10px rgba(10,100,255,0); } 100% { box-shadow: 0 0 0 0 rgba(10,100,255,0); } }
        .story-username { font-size: 0.8rem; margin-top: 4px; }
        /* Story viewer */
        .story-viewer { position: fixed; top:0; left:0; right:0; bottom:0; background:black; z-index:10000; display:flex; flex-direction:column; }
        .story-progress-bar { display:flex; gap:4px; padding:10px; }
        .progress-segment { height:3px; background:#333; flex:1; }
        .progress-segment.active { background:white; }
        .story-image { flex:1; background-size:contain; background-repeat:no-repeat; background-position:center; }
        /* Posts */
        .post { background:var(--card); border-radius:var(--radius); padding:20px; margin-bottom:20px; box-shadow:var(--shadow); }
        .post-header { display:flex; gap:12px; align-items:center; margin-bottom:12px; cursor:pointer; }
        .post-avatar { width:48px; height:48px; border-radius:48px; background:linear-gradient(135deg, var(--primary), var(--secondary)); display:flex; align-items:center; justify-content:center; color:white; font-weight:600; overflow:hidden; }
        .post-avatar img { width:100%; height:100%; object-fit:cover; }
        .post-username { font-weight:700; }
        .post-time { font-size:0.85rem; color:var(--text-light); display:flex; align-items:center; gap:4px; }
        .post-content { font-size:1.05rem; line-height:1.5; margin-bottom:12px; white-space:pre-wrap; }
        .post-image { max-width:100%; max-height:400px; border-radius:16px; margin-top:12px; cursor:pointer; }
        .post-actions { display:flex; gap:24px; border-top:1px solid var(--border); padding-top:16px; margin-top:8px; }
        .action-btn { background:none; border:none; display:flex; align-items:center; gap:8px; color:var(--text-light); font-size:1rem; cursor:pointer; padding:8px 12px; border-radius:30px; }
        .action-btn.liked { color:#FF3B30; }
        .action-btn.liked i { font-weight:900; }
        /* Comments */
        .comments-section { background:var(--bg); border-radius:16px; padding:16px; margin-top:16px; }
        .comment { display:flex; gap:12px; margin-bottom:16px; }
        .comment-avatar { width:32px; height:32px; border-radius:32px; background:linear-gradient(135deg, var(--primary), var(--secondary)); display:flex; align-items:center; justify-content:center; color:white; font-size:0.9rem; }
        .comment-user { font-weight:600; }
        .comment-text { background:var(--card); padding:8px 12px; border-radius:18px; display:inline-block; max-width:90%; }
        .add-comment { display:flex; gap:8px; margin-top:12px; }
        .add-comment input { flex:1; border:1px solid var(--border); border-radius:30px; padding:12px 16px; }
        .add-comment button { background:var(--primary); color:white; border:none; border-radius:30px; padding:0 20px; font-weight:600; cursor:pointer; }
        /* Ad banner */
        .ad-banner { background:var(--card); border-radius:var(--radius); padding:16px; margin-bottom:20px; display:flex; align-items:center; gap:16px; border:2px solid gold; }
        .ad-banner img { width:80px; height:80px; border-radius:12px; object-fit:cover; }
        .ad-info { flex:1; }
        .ad-cta { background:var(--primary); color:white; padding:10px 20px; border-radius:30px; text-decoration:none; display:inline-block; }
        /* Stats grid */
        .stats-grid { display:grid; grid-template-columns:repeat(auto-fit, minmax(150px,1fr)); gap:16px; margin-bottom:20px; }
        .stat-card { background:var(--bg); padding:20px; border-radius:12px; text-align:center; }
        .stat-card strong { display:block; font-size:2rem; color:var(--primary); }
        /* Admin section */
        .admin-section { background:var(--card); border-radius:var(--radius); padding:20px; margin-bottom:20px; }
        .form-group { margin-bottom:16px; }
        .form-group label { display:block; margin-bottom:6px; font-weight:600; }
        .form-group input, .form-group select { width:100%; padding:12px; border:1px solid var(--border); border-radius:12px; }
        /* Bottom navigation */
        .stash-nav {
            position: fixed; bottom:0; left:0; right:0; height:var(--nav-height);
            background:var(--card); border-top:1px solid var(--border); display:flex; padding:0 8px; z-index:1000;
        }
        .nav-item {
            flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center;
            gap:4px; color:var(--text-light); cursor:pointer;
        }
        .nav-item.active { color:var(--primary); }
        .nav-icon { font-size:1.4rem; position:relative; }
        .nav-badge { position:absolute; top:-6px; right:-8px; background:#FF3B30; color:white; font-size:0.7rem; min-width:18px; height:18px; border-radius:18px; display:flex; align-items:center; justify-content:center; padding:0 4px; }
        /* Utility */
        .hidden { display:none !important; }
        .page { display:none; }
        .page.active { display:block; }
    </style>
</head>
<body>
    <!-- Launch screen -->
    <div id="launchScreen">
        <div class="launch-logo">üì¶</div>
        <div class="launch-title">Stash</div>
    </div>
    <!-- Install banner -->
    <div id="installBanner">
        <div class="install-icon">üì±</div>
        <div class="install-info">
            <div class="install-title">Install Stash</div>
            <div class="install-desc">Get the app for quick access</div>
        </div>
        <button class="install-btn" onclick="installApp()" style="background:white; color:var(--primary); border:none; padding:8px 20px; border-radius:40px;">Install</button>
        <div class="install-close" onclick="hideInstallBanner()">‚úï</div>
    </div>
    <!-- Offline indicator -->
    <div id="offlineIndicator"><i class="fas fa-wifi-slash"></i> You are offline</div>
    <!-- Toast -->
    <div class="toast" id="toast"></div>
    <!-- Loading overlay -->
    <div class="loading-overlay" id="loadingOverlay"><div class="spinner"></div></div>

    <!-- Header -->
    <div class="stash-header" id="appHeader">
        <div class="header-title"><i class="fas fa-cube"></i> Stash</div>
        <div class="header-actions" id="headerActions"></div>
    </div>

    <!-- Main content (pages injected here) -->
    <div class="main-content" id="mainContent"></div>

    <!-- Bottom navigation -->
    <div class="stash-nav" id="bottomNav" style="display:none;">
        <div class="nav-item" data-page="home"><div class="nav-icon"><i class="fas fa-home"></i></div><div class="nav-label">Home</div></div>
        <div class="nav-item" data-page="explore"><div class="nav-icon"><i class="fas fa-compass"></i></div><div class="nav-label">Explore</div></div>
        <div class="nav-item" data-page="stories"><div class="nav-icon"><i class="fas fa-clock"></i></div><div class="nav-label">Stories</div></div>
        <div class="nav-item" data-page="earnings"><div class="nav-icon"><i class="fas fa-dollar-sign"></i></div><div class="nav-label">Earn</div></div>
        <div class="nav-item" data-page="profile"><div class="nav-icon"><i class="fas fa-user"></i></div><div class="nav-label">Me</div></div>
    </div>

    <!-- Font Awesome -->
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
    <script>
        // ---------- Supabase Configuration ----------
        const SUPABASE_URL = 'https://wfxpzfkbpejalbjhnzak.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_YMrDZyL_GsBlWCWt3KbOpQ_8bVcfKCi';
        const { createClient } = supabase;
        const _supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // ---------- Global State ----------
        let currentUser = null;
        let currentProfile = null;
        let activePage = 'home';
        let realtimeSubs = [];
        let deferredPrompt; // for PWA install

        // ---------- PWA ----------
        window.addEventListener('beforeinstallprompt', e => {
            e.preventDefault();
            deferredPrompt = e;
            setTimeout(() => {
                if(!window.matchMedia('(display-mode: standalone)').matches)
                    document.getElementById('installBanner').classList.add('show');
            }, 2000);
        });
        window.installApp = () => {
            if(deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then(() => { deferredPrompt = null; hideInstallBanner(); });
            }
        };
        window.hideInstallBanner = () => document.getElementById('installBanner').classList.remove('show');
        window.addEventListener('appinstalled', hideInstallBanner);

        // Online/offline
        window.addEventListener('online', () => {
            document.getElementById('offlineIndicator').classList.remove('show');
            showToast('Back online');
        });
        window.addEventListener('offline', () => document.getElementById('offlineIndicator').classList.add('show'));

        // ---------- Utilities ----------
        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerHTML = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 2500);
        }
        function showLoading(show) {
            document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
        }
        function timeSince(timestamp) {
            const seconds = Math.floor((Date.now() - new Date(timestamp).getTime())/1000);
            if(seconds < 60) return 'just now';
            const intervals = {year:31536000, month:2592000, day:86400, hour:3600, minute:60};
            for(let [unit, secs] of Object.entries(intervals)) {
                const interval = Math.floor(seconds/secs);
                if(interval >= 1) return interval + ' ' + unit + (interval>1?'s':'') + ' ago';
            }
            return 'long ago';
        }
        function escapeHtml(unsafe) {
            return unsafe.replace(/[&<>"]/g, m => {
                if(m === '&') return '&amp;';
                if(m === '<') return '&lt;';
                if(m === '>') return '&gt;';
                if(m === '"') return '&quot;';
                return m;
            });
        }

        // ---------- Authentication ----------
        async function checkUser() {
            const { data: { user } } = await _supabase.auth.getUser();
            currentUser = user;
            if(user) {
                const { data: profile } = await _supabase.from('profiles').select('*').eq('id', user.id).single();
                currentProfile = profile;
                document.getElementById('bottomNav').style.display = 'flex';
                // Add admin icon if admin
                const headerActions = document.getElementById('headerActions');
                headerActions.innerHTML = `<i class="fas fa-search header-icon" onclick="navigate('explore')"></i>`;
                if(profile?.is_admin) {
                    headerActions.innerHTML += `<i class="fas fa-cog header-icon" onclick="navigate('admin')"></i>`;
                }
                headerActions.innerHTML += `<div class="user-avatar" onclick="navigate('profile')">${profile?.username?.charAt(0).toUpperCase() || 'U'}</div>`;
                loadPage(activePage);
                subscribeToRealtime();
                fetchUnreadCounts();
            } else {
                document.getElementById('bottomNav').style.display = 'none';
                showAuthPage();
            }
        }

        async function signUp(email, password, username) {
            showLoading(true);
            const { data, error } = await _supabase.auth.signUp({ email, password, options: { data: { username } } });
            showLoading(false);
            if(error) showToast(error.message);
            else { showToast('Check your email for confirmation!'); showAuthPage(); }
        }

        async function signIn(email, password) {
            showLoading(true);
            const { data, error } = await _supabase.auth.signInWithPassword({ email, password });
            showLoading(false);
            if(error) showToast(error.message);
            else { currentUser = data.user; checkUser(); }
        }

        async function signOut() {
            await _supabase.auth.signOut();
            currentUser = null; currentProfile = null;
            checkUser();
        }

        // ---------- Page Navigation ----------
        function navigate(page) {
            activePage = page;
            loadPage(page);
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.querySelector(`.nav-item[data-page="${page}"]`)?.classList.add('active');
        }

        async function loadPage(page) {
            const container = document.getElementById('mainContent');
            if(!currentUser && page !== 'auth') { showAuthPage(); return; }
            if(page === 'auth') { showAuthPage(); return; }
            if(page === 'home') container.innerHTML = await renderHome();
            if(page === 'explore') container.innerHTML = await renderExplore();
            if(page === 'stories') container.innerHTML = await renderStoriesPage();
            if(page === 'earnings') container.innerHTML = await renderEarningsPage();
            if(page === 'profile') container.innerHTML = await renderProfile(currentProfile?.username);
            if(page === 'admin') container.innerHTML = await renderAdmin();
            // Scroll to top
            container.scrollTop = 0;
        }

        function showAuthPage() {
            document.getElementById('mainContent').innerHTML = `
                <div class="auth-container">
                    <div class="auth-tabs">
                        <div class="auth-tab active" onclick="switchAuthTab('login')">Login</div>
                        <div class="auth-tab" onclick="switchAuthTab('signup')">Sign Up</div>
                    </div>
                    <div id="auth-form">
                        <input type="email" id="email" class="auth-input" placeholder="Email">
                        <input type="password" id="password" class="auth-input" placeholder="Password">
                        <div id="signup-fields" style="display:none;">
                            <input type="text" id="username" class="auth-input" placeholder="Username">
                        </div>
                        <button class="auth-btn" onclick="handleAuth()">Continue</button>
                    </div>
                </div>
            `;
        }

        window.switchAuthTab = (tab) => {
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('signup-fields').style.display = tab === 'signup' ? 'block' : 'none';
        };

        window.handleAuth = () => {
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;
            const isLogin = document.querySelector('.auth-tab.active').innerText === 'Login';
            if(isLogin) signIn(email, pass);
            else {
                const username = document.getElementById('username').value;
                if(!username) { showToast('Username required'); return; }
                signUp(email, pass, username);
            }
        };

        // ---------- Home Feed with Stories and Ads ----------
        async function renderHome() {
            // Fetch stories (active in last 24h)
            const { data: stories } = await _supabase
                .from('stories')
                .select('*, profiles(username, avatar_url)')
                .gt('expires_at', new Date().toISOString())
                .order('created_at', { ascending: false });
            // Unique users for story circles
            const storyUsers = [];
            const seen = new Set();
            stories?.forEach(s => {
                if(!seen.has(s.user_id)) {
                    seen.add(s.user_id);
                    storyUsers.push(s);
                }
            });

            // Fetch posts (not disabled)
            const { data: posts } = await _supabase
                .from('posts')
                .select('*, profiles(username, avatar_url), likes(user_id), comments(*)')
                .eq('is_disabled', false)
                .order('created_at', { ascending: false });

            // Fetch active ad campaigns
            const { data: ads } = await _supabase
                .from('ad_campaigns')
                .select('*')
                .eq('status', 'active')
                .gt('budget', 0);

            let html = `
                <div class="stories-row" id="storiesRow">
                    ${storyUsers.map(s => `
                        <div class="story-circle" onclick="openStoryViewer('${s.user_id}')">
                            <div class="story-avatar ${await hasUnseenStories(s.user_id) ? 'unseen' : ''}">
                                <img src="${s.profiles.avatar_url || 'https://via.placeholder.com/70'}" alt="">
                            </div>
                            <span class="story-username">${s.profiles.username}</span>
                        </div>
                    `).join('')}
                    ${currentUser ? `<div class="story-circle" onclick="openAddStoryModal()">
                        <div class="story-avatar" style="background:var(--primary); display:flex; align-items:center; justify-content:center;">
                            <i class="fas fa-plus" style="color:white; font-size:2rem;"></i>
                        </div>
                        <span class="story-username">Add</span>
                    </div>` : ''}
                </div>
                <div class="compose-card">
                    <div class="compose-header">
                        <div class="compose-avatar">${currentProfile?.username?.charAt(0).toUpperCase() || 'U'}</div>
                        <textarea class="compose-textarea" id="postContent" rows="2" placeholder="What's on your mind?"></textarea>
                    </div>
                    <div class="compose-actions">
                        <label class="action-btn"><i class="fas fa-image"></i> <input type="file" id="postImage" accept="image/*" style="display:none;" onchange="previewImage()"></label>
                        <button class="post-btn" onclick="createPost()">Stash</button>
                    </div>
                    <div id="imagePreview" style="display:none; margin-top:12px;"><img id="previewImg" style="max-width:100%; max-height:200px; border-radius:12px;"></div>
                </div>
            `;

            let postCount = 0;
            for(let post of posts || []) {
                html += buildPostHTML(post);
                postCount++;
                if(postCount % 3 === 0 && ads?.length) {
                    const ad = ads[Math.floor(Math.random() * ads.length)];
                    html += `
                        <div class="ad-banner">
                            <img src="${ad.image_url}" alt="ad">
                            <div class="ad-info">
                                <h4>${escapeHtml(ad.title)}</h4>
                                <a href="${ad.target_url}" target="_blank" class="ad-cta" onclick="trackAdClick('${ad.id}')">Learn more</a>
                            </div>
                        </div>
                    `;
                }
            }

            return html;
        }

        function buildPostHTML(post) {
            const likedByMe = post.likes?.some(l => l.user_id === currentUser?.id);
            return `
                <div class="post" data-id="${post.id}" onmouseenter="trackPostView('${post.id}')">
                    <div class="post-header" onclick="navigateToProfile('${post.profiles.username}')">
                        <div class="post-avatar">${post.profiles.avatar_url ? `<img src="${post.profiles.avatar_url}">` : post.profiles.username?.charAt(0).toUpperCase()}</div>
                        <div>
                            <div class="post-username">${escapeHtml(post.profiles.username)}</div>
                            <div class="post-time"><i class="far fa-clock"></i> ${timeSince(post.created_at)} ¬∑ üëÅÔ∏è ${post.view_count || 0}</div>
                        </div>
                    </div>
                    <div class="post-content">${escapeHtml(post.content)}</div>
                    ${post.image_url ? `<img src="${post.image_url}" class="post-image" onclick="viewImage('${post.image_url}')">` : ''}
                    <div class="post-actions">
                        <button class="action-btn ${likedByMe ? 'liked' : ''}" onclick="toggleLike('${post.id}')"><i class="fa${likedByMe ? 's' : 'r'} fa-heart"></i> <span>${post.likes?.length || 0}</span></button>
                        <button class="action-btn" onclick="focusComment('${post.id}')"><i class="far fa-comment"></i> <span>${post.comments?.length || 0}</span></button>
                        ${currentProfile?.is_admin ? `<button class="action-btn" onclick="adminDisablePost('${post.id}')"><i class="fas fa-ban"></i></button>` : ''}
                    </div>
                    <div class="comments-section" id="comments-${post.id}">
                        ${renderComments(post.comments)}
                        <div class="add-comment">
                            <input type="text" id="commentInput-${post.id}" placeholder="Add a comment...">
                            <button onclick="addComment('${post.id}')">Post</button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderComments(comments) {
            if(!comments || comments.length === 0) return '';
            return comments.map(c => `
                <div class="comment">
                    <div class="comment-avatar">${c.profiles?.username?.charAt(0).toUpperCase() || 'U'}</div>
                    <div>
                        <span class="comment-user">${escapeHtml(c.profiles?.username)}</span>
                        <span class="comment-time">${timeSince(c.created_at)}</span>
                        <div class="comment-text">${escapeHtml(c.content)}</div>
                    </div>
                </div>
            `).join('');
        }

        // ---------- Stories ----------
        let currentStoryUser = null;
        let storyQueue = [];

        async function hasUnseenStories(userId) {
            // Check if current user has viewed all stories from this user
            const { data: views } = await _supabase
                .from('story_views')
                .select('story_id')
                .eq('viewer_id', currentUser?.id)
                .in('story_id', (await _supabase.from('stories').select('id').eq('user_id', userId)).data?.map(s => s.id) || []);
            const viewedIds = new Set(views?.map(v => v.story_id) || []);
            const { data: stories } = await _supabase.from('stories').select('id').eq('user_id', userId).gt('expires_at', new Date().toISOString());
            return stories?.some(s => !viewedIds.has(s.id));
        }

        async function openStoryViewer(userId) {
            const { data: stories } = await _supabase
                .from('stories')
                .select('*')
                .eq('user_id', userId)
                .gt('expires_at', new Date().toISOString())
                .order('created_at', { ascending: true });
            if(!stories || stories.length === 0) return;
            storyQueue = stories;
            currentStoryUser = userId;
            renderStoryViewer(0);
        }

        function renderStoryViewer(index) {
            if(index >= storyQueue.length) {
                document.getElementById('storyViewer')?.remove();
                return;
            }
            const story = storyQueue[index];
            const viewer = document.createElement('div');
            viewer.id = 'storyViewer';
            viewer.className = 'story-viewer';
            viewer.innerHTML = `
                <div class="story-progress-bar">
                    ${storyQueue.map((_, i) => `<div class="progress-segment ${i === index ? 'active' : ''}" style="width:${100/storyQueue.length}%"></div>`).join('')}
                </div>
                <div class="story-image" style="background-image:url('${story.media_url}')"></div>
                <div style="position:absolute; bottom:20px; left:0; right:0; text-align:center; color:white;">
                    <button onclick="closeStoryViewer()">Close</button>
                </div>
            `;
            document.body.appendChild(viewer);
            const startTime = Date.now();
            const timer = setTimeout(() => {
                const duration = Math.floor((Date.now() - startTime) / 1000);
                _supabase.from('story_views').insert({ story_id: story.id, viewer_id: currentUser.id, view_duration: duration });
                renderStoryViewer(index + 1);
            }, 5000);
            viewer.addEventListener('click', (e) => {
                if(e.target.tagName === 'BUTTON') return;
                clearTimeout(timer);
                renderStoryViewer(index + 1);
            });
        }

        function closeStoryViewer() {
            document.getElementById('storyViewer')?.remove();
        }

        function openAddStoryModal() {
            // Simple: prompt for image URL (in real app you'd upload file)
            const url = prompt('Enter image URL for your story:');
            if(url) {
                _supabase.from('stories').insert({ user_id: currentUser.id, media_url: url, media_type: 'image' });
                showToast('Story added!');
            }
        }

        // ---------- Post Interactions ----------
        window.createPost = async () => {
            const content = document.getElementById('postContent').value;
            const file = document.getElementById('postImage').files[0];
            let imageUrl = null;
            if(file) {
                showLoading(true);
                const fileName = `${currentUser.id}/${Date.now()}-${file.name}`;
                const { data, error } = await _supabase.storage.from('stash-images').upload(fileName, file);
                if(error) { showToast('Image upload failed'); showLoading(false); return; }
                const { data: { publicUrl } } = _supabase.storage.from('stash-images').getPublicUrl(fileName);
                imageUrl = publicUrl;
                showLoading(false);
            }
            const { error } = await _supabase.from('posts').insert({ user_id: currentUser.id, content, image_url: imageUrl });
            if(error) showToast('Error creating post');
            else {
                document.getElementById('postContent').value = '';
                document.getElementById('postImage').value = '';
                document.getElementById('imagePreview').style.display = 'none';
                loadPage('home');
            }
        };

        window.toggleLike = async (postId) => {
            const { data: existing } = await _supabase.from('likes').select().eq('user_id', currentUser.id).eq('post_id', postId).maybeSingle();
            if(existing) {
                await _supabase.from('likes').delete().eq('id', existing.id);
            } else {
                await _supabase.from('likes').insert({ user_id: currentUser.id, post_id: postId });
                // Notify post owner
                const { data: post } = await _supabase.from('posts').select('user_id').eq('id', postId).single();
                if(post.user_id !== currentUser.id) {
                    await _supabase.from('notifications').insert({ user_id: post.user_id, type: 'like', reference_id: postId });
                }
            }
            loadPage(activePage);
        };

        window.addComment = async (postId) => {
            const input = document.getElementById(`commentInput-${postId}`);
            const content = input.value.trim();
            if(!content) return;
            const { error } = await _supabase.from('comments').insert({ user_id: currentUser.id, post_id: postId, content });
            if(!error) {
                input.value = '';
                const { data: post } = await _supabase.from('posts').select('user_id').eq('id', postId).single();
                if(post.user_id !== currentUser.id) {
                    await _supabase.from('notifications').insert({ user_id: post.user_id, type: 'comment', reference_id: postId });
                }
                loadPage(activePage);
            }
        };

        window.focusComment = (postId) => document.getElementById(`commentInput-${postId}`)?.focus();

        // Track post view (for earnings)
        window.trackPostView = async (postId) => {
            if(!currentUser) return;
            // Simple check: only track once per session? Use a Set to avoid duplicates
            if(!window.viewedPosts) window.viewedPosts = new Set();
            if(window.viewedPosts.has(postId)) return;
            window.viewedPosts.add(postId);
            await _supabase.from('post_views').insert({ post_id: postId, viewer_id: currentUser.id });
            await _supabase.rpc('increment_post_view', { post_id: postId });
            // Optionally add to user's earnings (handled by a database trigger or function)
        };

        // ---------- Earnings & Withdrawals ----------
        async function renderEarningsPage() {
            const { data: views } = await _supabase
                .from('post_views')
                .select('*, posts(user_id)')
                .eq('posts.user_id', currentUser.id);
            // Get earnings rate from settings
            const { data: settings } = await _supabase.from('admin_settings').select('value').eq('key', 'post_earnings_rate').single();
            const rate = settings?.value || 0.01;
            const earnings = (views?.length || 0) * rate;
            const { data: withdrawals } = await _supabase
                .from('withdrawals')
                .select('*')
                .eq('user_id', currentUser.id)
                .order('requested_at', { ascending: false });
            return `
                <h2>Your Earnings</h2>
                <div class="stats-grid">
                    <div class="stat-card"><span>Post Views</span><strong>${views?.length || 0}</strong></div>
                    <div class="stat-card"><span>Earned</span><strong>$${earnings.toFixed(2)}</strong></div>
                    <div class="stat-card"><span>Balance</span><strong>$${currentProfile?.balance || 0}</strong></div>
                </div>
                <div class="admin-section">
                    <h3>Withdraw Funds</h3>
                    <input type="number" id="withdrawAmount" placeholder="Amount ($)" min="10" step="0.01">
                    <select id="withdrawMethod">
                        <option value="paypal">PayPal</option>
                        <option value="mpesa">M-Pesa</option>
                    </select>
                    <input type="text" id="withdrawAccount" placeholder="Account details (email/phone)">
                    <button class="post-btn" onclick="requestWithdrawal()">Request</button>
                </div>
                <div class="admin-section">
                    <h3>Withdrawal History</h3>
                    ${withdrawals?.map(w => `
                        <div>$${w.amount} - ${w.status} (${timeSince(w.requested_at)})</div>
                    `).join('')}
                </div>
            `;
        }

        window.requestWithdrawal = async () => {
            const amount = parseFloat(document.getElementById('withdrawAmount').value);
            const method = document.getElementById('withdrawMethod').value;
            const account = document.getElementById('withdrawAccount').value;
            if(amount > (currentProfile?.balance || 0)) { showToast('Insufficient balance'); return; }
            if(amount < 10) { showToast('Minimum withdrawal $10'); return; }
            const { error } = await _supabase.from('withdrawals').insert({
                user_id: currentUser.id,
                amount,
                payment_method: method,
                account_details: account
            });
            if(!error) showToast('Request submitted');
        };

        // ---------- Admin Panel ----------
        async function renderAdmin() {
            if(!currentProfile?.is_admin) return '<p>Access denied</p>';
            const { count: users } = await _supabase.from('profiles').select('*', { count: 'exact', head: true });
            const { count: posts } = await _supabase.from('posts').select('*', { count: 'exact', head: true });
            const { count: pendingWithdrawals } = await _supabase.from('withdrawals').select('*', { count: 'exact', head: true }).eq('status', 'pending');
            const { data: settings } = await _supabase.from('admin_settings').select('*');
            const settingsMap = Object.fromEntries(settings.map(s => [s.key, s.value]));
            return `
                <h2>Admin Dashboard</h2>
                <div class="stats-grid">
                    <div class="stat-card"><span>Users</span><strong>${users}</strong></div>
                    <div class="stat-card"><span>Posts</span><strong>${posts}</strong></div>
                    <div class="stat-card"><span>Pending Withdrawals</span><strong>${pendingWithdrawals}</strong></div>
                </div>
                <div class="admin-section">
                    <h3>Settings</h3>
                    <div class="form-group">
                        <label>Ad System Enabled</label>
                        <input type="checkbox" id="adEnabled" ${settingsMap.ad_system_enabled ? 'checked' : ''}>
                    </div>
                    <div class="form-group">
                        <label>Default CPC ($)</label>
                        <input type="number" id="defaultCPC" value="${settingsMap.default_cpc || 0.1}" step="0.01">
                    </div>
                    <div class="form-group">
                        <label>Default CPM ($)</label>
                        <input type="number" id="defaultCPM" value="${settingsMap.default_cpm || 1.0}" step="0.01">
                    </div>
                    <div class="form-group">
                        <label>Commission %</label>
                        <input type="number" id="commission" value="${settingsMap.commission_percentage || 10}">
                    </div>
                    <div class="form-group">
                        <label>Post Earnings Rate ($ per view)</label>
                        <input type="number" id="postRate" value="${settingsMap.post_earnings_rate || 0.01}" step="0.001">
                    </div>
                    <button class="post-btn" onclick="saveAdminSettings()">Save Settings</button>
                </div>
                <div class="admin-section">
                    <h3>Pending Withdrawals</h3>
                    <div id="withdrawalList"></div>
                </div>
                <div class="admin-section">
                    <h3>Users</h3>
                    <div id="userList"></div>
                </div>
                <div class="admin-section">
                    <h3>Posts</h3>
                    <div id="postList"></div>
                </div>
            `;
        }

        async function saveAdminSettings() {
            const updates = [
                { key: 'ad_system_enabled', value: document.getElementById('adEnabled').checked },
                { key: 'default_cpc', value: parseFloat(document.getElementById('defaultCPC').value) },
                { key: 'default_cpm', value: parseFloat(document.getElementById('defaultCPM').value) },
                { key: 'commission_percentage', value: parseFloat(document.getElementById('commission').value) },
                { key: 'post_earnings_rate', value: parseFloat(document.getElementById('postRate').value) }
            ];
            for(let u of updates) {
                await _supabase.from('admin_settings').upsert({ key: u.key, value: u.value });
            }
            showToast('Settings saved');
        }

        window.adminDisablePost = async (postId) => {
            await _supabase.from('posts').update({ is_disabled: true }).eq('id', postId);
            showToast('Post disabled');
            loadPage(activePage);
        };

        // ---------- Ad Tracking ----------
        window.trackAdClick = async (campaignId) => {
            if(!currentUser) return;
            const { data: campaign } = await _supabase.from('ad_campaigns').select('*').eq('id', campaignId).single();
            if(campaign.campaign_type === 'cpc') {
                const cost = campaign.cpc;
                await _supabase.from('ad_clicks').insert({ campaign_id: campaignId, user_id: currentUser.id, cost });
                await _supabase.rpc('deduct_ad_budget', { camp_id: campaignId, amount: cost });
            }
        };

        // ---------- Realtime ----------
        function subscribeToRealtime() {
            realtimeSubs.forEach(sub => sub.unsubscribe());
            realtimeSubs = [];

            const postSub = _supabase.channel('public:posts')
                .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'posts' }, () => {
                    if(activePage === 'home') loadPage('home');
                })
                .subscribe();
            realtimeSubs.push(postSub);

            const notifSub = _supabase.channel('notifications:'+currentUser?.id)
                .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'notifications', filter: `user_id=eq.${currentUser?.id}` }, () => {
                    fetchUnreadCounts();
                    if(activePage === 'notifications') loadPage('notifications');
                })
                .subscribe();
            realtimeSubs.push(notifSub);
        }

        async function fetchUnreadCounts() {
            if(!currentUser) return;
            const { count: notifCount } = await _supabase.from('notifications').select('*', { count: 'exact', head: true }).eq('user_id', currentUser.id).eq('read', false);
            const badge = document.querySelector('.nav-item[data-page="notifications"] .nav-badge');
            if(badge) {
                badge.innerText = notifCount || '';
                badge.style.display = notifCount ? 'flex' : 'none';
            }
        }

        // ---------- Profile ----------
        async function renderProfile(username) {
            const { data: profile } = await _supabase.from('profiles').select('*').eq('username', username).single();
            if(!profile) return '<p>User not found</p>';
            const { data: posts } = await _supabase.from('posts').select('*, likes(user_id), comments(*)').eq('user_id', profile.id).order('created_at', { ascending: false });
            const { count: followers } = await _supabase.from('follows').select('*', { count: 'exact', head: true }).eq('following_id', profile.id);
            const { count: following } = await _supabase.from('follows').select('*', { count: 'exact', head: true }).eq('follower_id', profile.id);
            const isFollowing = currentUser ? (await _supabase.from('follows').select().eq('follower_id', currentUser.id).eq('following_id', profile.id).maybeSingle()).data : null;
            return `
                <div class="profile-header">
                    <div class="profile-avatar-large">${profile.avatar_url ? `<img src="${profile.avatar_url}">` : profile.username?.charAt(0).toUpperCase()}</div>
                    <div>
                        <h2>${escapeHtml(profile.username)}</h2>
                        <p>${escapeHtml(profile.bio || '')}</p>
                        <div class="profile-stats">
                            <div class="stat"><span class="stat-number">${posts?.length || 0}</span><br>Posts</div>
                            <div class="stat"><span class="stat-number">${followers}</span><br>Followers</div>
                            <div class="stat"><span class="stat-number">${following}</span><br>Following</div>
                        </div>
                        ${currentUser && currentUser.id !== profile.id ? `<button class="follow-btn" onclick="toggleFollow('${profile.id}')">${isFollowing ? 'Unfollow' : 'Follow'}</button>` : ''}
                    </div>
                </div>
                <div class="posts-feed">
                    ${posts?.map(p => `
                        <div class="post">
                            <div class="post-content">${escapeHtml(p.content)}</div>
                            ${p.image_url ? `<img src="${p.image_url}" class="post-image">` : ''}
                            <div class="post-actions">
                                <span><i class="far fa-heart"></i> ${p.likes?.length || 0}</span>
                                <span><i class="far fa-comment"></i> ${p.comments?.length || 0}</span>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        window.toggleFollow = async (targetId) => {
            const { data: existing } = await _supabase.from('follows').select().eq('follower_id', currentUser.id).eq('following_id', targetId).maybeSingle();
            if(existing) {
                await _supabase.from('follows').delete().eq('id', existing.id);
            } else {
                await _supabase.from('follows').insert({ follower_id: currentUser.id, following_id: targetId });
                await _supabase.from('notifications').insert({ user_id: targetId, type: 'follow', reference_id: currentUser.id });
            }
            loadPage('profile');
        };

        // ---------- Explore (placeholder) ----------
        async function renderExplore() {
            const { data: posts } = await _supabase
                .from('posts')
                .select('*, profiles(username, avatar_url), likes(user_id), comments(*)')
                .eq('is_disabled', false)
                .order('created_at', { ascending: false })
                .limit(50);
            let html = '<h2>Explore</h2>';
            posts?.forEach(p => { html += buildPostHTML(p); });
            return html;
        }

        async function renderStoriesPage() {
            return '<h2>Stories</h2><p>Coming soon: view all stories here.</p>';
        }

        // ---------- Initialization ----------
        window.onload = async () => {
            setTimeout(() => document.getElementById('launchScreen').style.display = 'none', 1500);
            await checkUser();
        };
        window.navigate = navigate;
    </script>
</body>
</html>
